{"version":3,"sources":["../dist-tsc/schemaFunctions.js"],"names":["Object","defineProperty","exports","value","utils_1","require","ethABI","wyvern_js_1","types_1","failWith","msg","Error","encodeReplacementPattern","WyvernProtocol","encodeCall","abi","parameters","inputTypes","inputs","map","i","type","Buffer","concat","methodID","name","rawEncode","toString","encodeSell","schema","asset","address","transfer","getTransferFunction","target","calldata","encodeDefaultCall","replacementPattern","encodeAtomicizedSell","assets","atomicizer","transactions","BigNumber","atomicizedCalldata","atomicize","getABIEncodedTransactionData","t","length","reduce","x","y","slice","atomicizedReplacementPattern","encodeAtomicizedReplacementPattern","encodeAtomicizedBuy","encodeBuy","FunctionInputKind","Owner","replaceables","filter","kind","Replaceable","ownerInputs","input","generateDefaultValue","Asset","functions","transferFrom"],"mappings":"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","file":"schemaFunctions.js","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst utils_1 = require(\"@0xproject/utils\");\nconst ethABI = require(\"ethereumjs-abi\");\nconst wyvern_js_1 = require(\"wyvern-js\");\nconst types_1 = require(\"./types\");\nconst failWith = (msg) => {\n    throw new Error(msg);\n};\nexports.encodeReplacementPattern = wyvern_js_1.WyvernProtocol.encodeReplacementPattern;\nexports.encodeCall = (abi, parameters) => {\n    const inputTypes = abi.inputs.map(i => i.type);\n    return '0x' + Buffer.concat([\n        ethABI.methodID(abi.name, inputTypes),\n        ethABI.rawEncode(inputTypes, parameters),\n    ]).toString('hex');\n};\nexports.encodeSell = (schema, asset, address) => {\n    const transfer = getTransferFunction(schema)(asset);\n    return {\n        target: transfer.target,\n        calldata: exports.encodeDefaultCall(transfer, address),\n        replacementPattern: exports.encodeReplacementPattern(transfer),\n    };\n};\nexports.encodeAtomicizedSell = (schema, assets, address, atomicizer) => {\n    const transactions = assets.map(asset => {\n        const { target, calldata } = exports.encodeSell(schema, asset, address);\n        return {\n            calldata,\n            abi: getTransferFunction(schema)(asset),\n            address: target,\n            value: new utils_1.BigNumber(0),\n        };\n    });\n    const atomicizedCalldata = atomicizer.atomicize.getABIEncodedTransactionData(transactions.map(t => t.address), transactions.map(t => t.value), transactions.map(t => new utils_1.BigNumber((t.calldata.length - 2) / 2)), // subtract 2 for '0x', divide by 2 for hex\n    transactions.map(t => t.calldata).reduce((x, y) => x + y.slice(2)));\n    const atomicizedReplacementPattern = wyvern_js_1.WyvernProtocol.encodeAtomicizedReplacementPattern(transactions.map(t => t.abi));\n    return {\n        calldata: atomicizedCalldata,\n        replacementPattern: atomicizedReplacementPattern,\n    };\n};\nexports.encodeAtomicizedBuy = (schema, assets, address, atomicizer) => {\n    const transactions = assets.map(asset => {\n        const { target, calldata } = exports.encodeBuy(schema, asset, address);\n        return {\n            calldata,\n            abi: getTransferFunction(schema)(asset),\n            address: target,\n            value: new utils_1.BigNumber(0),\n        };\n    });\n    const atomicizedCalldata = atomicizer.atomicize.getABIEncodedTransactionData(transactions.map(t => t.address), transactions.map(t => t.value), transactions.map(t => new utils_1.BigNumber((t.calldata.length - 2) / 2)), // subtract 2 for '0x', divide by 2 for hex\n    transactions.map(t => t.calldata).reduce((x, y) => x + y.slice(2)));\n    const atomicizedReplacementPattern = wyvern_js_1.WyvernProtocol.encodeAtomicizedReplacementPattern(transactions.map(t => t.abi), types_1.FunctionInputKind.Owner);\n    return {\n        calldata: atomicizedCalldata,\n        replacementPattern: atomicizedReplacementPattern,\n    };\n};\nexports.encodeBuy = (schema, asset, address) => {\n    const transfer = getTransferFunction(schema)(asset);\n    const replaceables = transfer.inputs.filter((i) => i.kind === types_1.FunctionInputKind.Replaceable);\n    const ownerInputs = transfer.inputs.filter((i) => i.kind === types_1.FunctionInputKind.Owner);\n    // Validate\n    if (replaceables.length !== 1) {\n        failWith('Only 1 input can match transfer destination, but instead ' + replaceables.length + ' did');\n    }\n    // Compute calldata\n    const parameters = transfer.inputs.map((input) => {\n        switch (input.kind) {\n            case types_1.FunctionInputKind.Replaceable:\n                return address;\n            case types_1.FunctionInputKind.Owner:\n                return wyvern_js_1.WyvernProtocol.generateDefaultValue(input.type);\n            default:\n                return input.value.toString();\n        }\n    });\n    const calldata = exports.encodeCall(transfer, parameters);\n    // Compute replacement pattern\n    let replacementPattern = '0x';\n    if (ownerInputs.length > 0) {\n        replacementPattern = exports.encodeReplacementPattern(transfer, types_1.FunctionInputKind.Owner);\n    }\n    return {\n        target: transfer.target,\n        calldata,\n        replacementPattern,\n    };\n};\nexports.encodeDefaultCall = (abi, address) => {\n    const parameters = abi.inputs.map(input => {\n        switch (input.kind) {\n            case types_1.FunctionInputKind.Asset:\n                return input.value;\n            case types_1.FunctionInputKind.Replaceable:\n                return wyvern_js_1.WyvernProtocol.generateDefaultValue(input.type);\n            case types_1.FunctionInputKind.Owner:\n                return address;\n        }\n    });\n    return exports.encodeCall(abi, parameters);\n};\nfunction getTransferFunction(schema) {\n    return schema.functions.transferFrom\n        || schema.functions.transfer;\n}\n//# sourceMappingURL=schemaFunctions.js.map"]}